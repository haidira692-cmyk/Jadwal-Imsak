<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imsakiyah & Sholat Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { 
            --primary: #004d40; --accent: #ffc107; --bg: #f4f7f6; --danger: #d32f2f; 
            --maghrib: #e65100; --text: #333; --card-bg: #ffffff; --border: #eee;
        }
        body.dark-theme {
            --bg: #121212; --text: #e0e0e0; --card-bg: #1e1e1e; --border: #333;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; transition: 0.3s; }
        .card { background: var(--card-bg); padding: 25px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; position: relative; }
        .theme-toggle { position: absolute; top: 15px; right: 15px; background: var(--primary); color: white; border: none; width: 38px; height: 38px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; z-index: 10; }
        .clock-live { font-size: 1.3rem; font-weight: bold; color: var(--primary); margin-bottom: 5px; }
        .date-live { font-size: 0.9rem; opacity: 0.7; margin-bottom: 10px; border-bottom: 2px solid var(--border); padding-bottom: 10px; }
        .search-container { position: relative; margin: 20px 0; }
        input { width: 100%; padding: 15px 45px 15px 15px; border: 2px solid var(--border); border-radius: 12px; box-sizing: border-box; outline: none; font-size: 1rem; background: var(--card-bg); color: var(--text); }
        #clearInput { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #999; display: none; }
        .btn-gps { background: transparent; color: var(--primary); border: 2px solid var(--primary); padding: 12px; width: 100%; border-radius: 12px; cursor: pointer; font-weight: bold; margin-bottom: 15px; }
        .autocomplete-list { position: absolute; width: 100%; background: var(--card-bg); border: 1px solid var(--border); z-index: 99; max-height: 200px; overflow-y: auto; text-align: left; border-radius: 10px; display: none; }
        .autocomplete-list div { padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .countdown-card { background: var(--primary); color: white; padding: 20px; border-radius: 18px; margin-bottom: 20px; transition: 0.5s ease; }
        .countdown-time { font-size: 2.8rem; font-weight: bold; color: var(--accent); letter-spacing: 1px; }
        .imsak-display { font-size: 3.5rem; font-weight: bold; color: var(--danger); line-height: 1; margin: 10px 0; }
        
        /* Grid 5 Waktu Lengkap */
        .jadwal-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .info-box { background: var(--bg); padding: 10px 5px; border-radius: 12px; font-size: 0.8rem; opacity: 0.8; border: 1px solid var(--border); }
        .info-box b { display: block; font-size: 1rem; color: var(--text); }

        /* Sosmed & Share */
        .footer { margin-top: 25px; width: 100%; max-width: 450px; text-align: center; font-size: 0.8rem; opacity: 0.8; }
        .social-links { margin: 15px 0; display: flex; justify-content: center; gap: 20px; }
        .social-links a { color: var(--primary); font-size: 1.3rem; transition: 0.3s; }
        .btn-share { background: #25d366; color: white; padding: 10px 20px; border-radius: 50px; text-decoration: none; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; margin-bottom: 15px; }
        .footer-note { background: #fff3e0; color: #e65100; padding: 12px; border-radius: 12px; margin-top: 10px; border: 1px solid #ffe0b2; text-align: left; }
        body.dark-theme .footer-note { background: #2a1b00; border-color: #4d3300; }
        #notifPopup { display: none; position: fixed; top: 20px; background: var(--maghrib); color: white; padding: 15px 30px; border-radius: 50px; font-weight: bold; z-index: 10000; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

<div id="notifPopup">üîî ALLAHU AKBAR! WAKTU BERBUKA TIBA</div>

<div class="card">
    <button class="theme-toggle" id="themeBtn" onclick="toggleTheme()">üåô</button>
    <div class="clock-live" id="liveClock">00:00:00</div>
    <div class="date-live" id="liveDate">Memuat hari...</div>
    
    <h2>üåô Imsakiyah Pro</h2>
    <button class="btn-gps" onclick="getLocation()">üìç Gunakan Lokasi Saya</button>
    
    <div class="search-container">
        <input type="text" id="inputKota" placeholder="Ketik nama kota..." autocomplete="off">
        <span id="clearInput" onclick="hapusInput()">&#10006;</span>
        <div id="listKota" class="autocomplete-list"></div>
    </div>

    <div id="resultBox" style="display:none;">
        <div class="countdown-card" id="countCard">
            <small id="labelCount" style="font-weight:600; text-transform:uppercase;">--</small>
            <div class="countdown-time" id="textCount">00:00:00</div>
        </div>
        
        <div style="border: 2px solid var(--border); padding: 15px; border-radius: 20px;">
            <strong id="resKota" style="text-transform: uppercase; color: var(--primary);">-</strong>
            <div class="imsak-display" id="resImsak">--:--</div>
            <div id="resDetail" style="font-weight: bold; margin-bottom:12px;">Imsak & Subuh</div>
            
            <div class="jadwal-grid">
                <div class="info-box">Dzuhur <b id="vDz">--:--</b></div>
                <div class="info-box">Ashar <b id="vAs">--:--</b></div>
                <div class="info-box">Maghrib <b id="vMa">--:--</b></div>
                <div class="info-box" style="grid-column: span 3;">Isya <b id="vIs">--:--</b></div>
            </div>
            <div id="resTanggalApi" style="font-size: 0.75rem; margin-top: 10px; opacity: 0.5;"></div>
        </div>
    </div>
</div>

<div class="footer">
    <a href="#" id="waShare" class="btn-share" target="_blank"><i class="fab fa-whatsapp"></i> Bagikan Jadwal</a>
    
    <div>Dibuat oleh <strong>Sultan Ahmad Haidir</strong></div>
    
    <div class="social-links">
        <a href="https://instagram.com/sultanahmadhaidir" target="_blank"><i class="fab fa-instagram"></i></a>
        <a href="https://github.com/haidira692-cmyk" target="_blank"><i class="fab fa-github"></i></a>
        <a href="https://wa.me/6282271359373" target="_blank"><i class="fab fa-whatsapp"></i></a>
    </div>
    
    <div class="footer-note">
        <strong>Pemberitahuan:</strong> Jadwal sinkron dengan API Kemenag RI. Selalu dahulukan adzan dari masjid setempat. 
        <a id="waReport" href="#" target="_blank">Lapor jika ada selisih waktu</a>.
    </div>
    <p>¬© 2026 Digital Imsakiyah - Versi 2.0</p>
</div>
</div>

<audio id="adzanAudio" src="https://www.islamcan.com/audio/adzan/azan1.mp3" preload="auto"></audio>

<script>
    let daftarKota = [], fuse, countdownInterval, currentResults = [], hasBeeped = [];
    const input = document.getElementById('inputKota');
    const clearBtn = document.getElementById('clearInput');

    if(localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-theme'); document.getElementById('themeBtn').innerText = '‚òÄÔ∏è'; }

    function toggleTheme() {
        document.body.classList.toggle('dark-theme');
        const isDark = document.body.classList.contains('dark-theme');
        document.getElementById('themeBtn').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    setInterval(() => { 
        const n = new Date();
        document.getElementById('liveClock').innerText = n.toLocaleTimeString('id-ID'); 
        document.getElementById('liveDate').innerText = n.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }, 1000);

    async function init() {
        try {
            const res = await fetch('https://api.myquran.com/v2/sholat/kota/semua');
            const data = await res.json();
            daftarKota = data.data;
            fuse = new Fuse(daftarKota, { keys: ['lokasi'], threshold: 0.4 });
            const lastId = localStorage.getItem('lastId'), lastNama = localStorage.getItem('lastNama');
            if(lastId) pilihKota(lastId, lastNama);
        } catch (e) {}
    }

    input.addEventListener('input', function() {
        const list = document.getElementById('listKota');
        list.innerHTML = '';
        clearBtn.style.display = this.value.length > 0 ? "block" : "none";
        if (this.value.length < 2) { list.style.display = 'none'; return; }
        currentResults = fuse.search(this.value).slice(0, 5);
        currentResults.forEach((r, i) => {
            const div = document.createElement('div');
            div.innerHTML = (i === 0 && r.item.lokasi.toLowerCase() !== this.value.toLowerCase()) ? `<small style="color:orange;display:block">SARAN:</small>${r.item.lokasi}` : r.item.lokasi;
            div.onclick = () => pilihKota(r.item.id, r.item.lokasi);
            list.appendChild(div);
        });
        list.style.display = 'block';
    });

    input.addEventListener('keydown', (e) => { if (e.key === 'Enter' && currentResults.length > 0) { pilihKota(currentResults[0].item.id, currentResults[0].item.lokasi); document.getElementById('listKota').style.display = 'none'; input.blur(); } });

    function hapusInput() { input.value = ""; clearBtn.style.display = "none"; document.getElementById('listKota').style.display = "none"; input.focus(); }

    // function getLocation() {
    //     const btn = document.getElementById('btnGps'), loader = document.getElementById('loader');
    //     btn.disabled = true; loader.style.display = 'block';
    //     navigator.geolocation.getCurrentPosition(async (pos) => {
    //         const res = await fetch(`https://api.myquran.com/v2/sholat/kota/lokasi/${pos.coords.latitude}/${pos.coords.longitude}`);
    //         const data = await res.json();
    //         btn.disabled = false; loader.style.display = 'none';
    //         if(data.data) pilihKota(data.data.id, data.data.lokasi);
    //     }, () => { btn.disabled = false; loader.style.display = 'none'; alert("Gagal GPS"); });
    // }

    // Ganti fungsi getLocation yang lama dengan ini:
    function getLocation() {
        Swal.fire({
            title: 'Mohon Maaf üôè',
            text: 'Fitur deteksi lokasi otomatis sedang dalam tahap pengembangan agar lebih akurat.',
            icon: 'info',
            confirmButtonText: 'Siap, saya cari manual!',
            confirmButtonColor: '#004d40',
            showClass: {
                popup: 'animate__animated animate__fadeInDown'
            },
            hideClass: {
                popup: 'animate__animated animate__fadeOutUp'
            }
        }).then((result) => {
            if (result.isConfirmed) {
                document.getElementById('inputKota').focus();
            }
        });
    }

    async function pilihKota(id, nama) {
        input.value = nama; clearBtn.style.display = "block"; document.getElementById('listKota').style.display = 'none';
        
        const t = new Date();
        const res = await fetch(`https://api.myquran.com/v2/sholat/jadwal/${id}/${t.getFullYear()}/${t.getMonth()+1}/${t.getDate()}`);
        const d = await res.json();
        const j = d.data.jadwal;
        
        document.getElementById('resultBox').style.display = 'block';
        document.getElementById('resKota').innerText = nama;
        document.getElementById('resImsak').innerText = j.imsak;
        document.getElementById('vDz').innerText = j.dzuhur; 
        document.getElementById('vAs').innerText = j.ashar; 
        document.getElementById('vMa').innerText = j.maghrib;
        document.getElementById('vIs').innerText = j.isya; // Isya Fix Muncul
        document.getElementById('resTanggalApi').innerText = j.tanggal;

        // Link Share WA otomatis
        const textShare = `Jadwal Imsakiyah & Sholat untuk ${nama} hari ini:\nImsak: ${j.imsak}\nMaghrib: ${j.maghrib}\n\nCek lengkap di: ${window.location.href}`;
        document.getElementById('waShare').href = `https://wa.me/?text=${encodeURIComponent(textShare)}`;
        document.getElementById('waReport').href = `https://wa.me/6282271359373?text=Lapor%20jadwal%20${encodeURIComponent(nama)}`;

        localStorage.setItem('lastId', id); localStorage.setItem('lastNama', nama);
        startGlobalLogic(j.imsak, j.maghrib);
    }

    function startGlobalLogic(imsakT, maghribT) {
        if(countdownInterval) clearInterval(countdownInterval);
        hasBeeped = [];
        countdownInterval = setInterval(() => {
            const now = new Date();
            const tImsak = parseTime(imsakT), tMaghrib = parseTime(maghribT);
            let diffI = tImsak - now, diffM = tMaghrib - now;
            let time, label, color;

            if (diffI > 0) {
                time = diffI; label = "Menuju Imsak"; color = "#004d40";
                let m = Math.floor(diffI/60000);
                if(m < 5 && m >= 0 && !hasBeeped.includes(m)) { playBeep(440, 0.2); hasBeeped.push(m); }
            } else if (diffM > 0) {
                time = diffM; label = "Menuju Buka Puasa"; color = "#e65100";
            } else {
                time = (new Date(tImsak.getTime() + 86400000)) - now; label = "Menuju Imsak Besok"; color = "#004d40";
            }
            document.getElementById('labelCount').innerText = label;
            document.getElementById('countCard').style.background = color;
            const h = Math.floor(time/3600000).toString().padStart(2,'0'), m = Math.floor((time%3600000)/60000).toString().padStart(2,'0'), s = Math.floor((time%60000)/1000).toString().padStart(2,'0');
            document.getElementById('textCount').innerText = `${h}:${m}:${s}`;
            if(diffM <= 0 && diffM > -2000) { document.getElementById('adzanAudio').play().catch(()=>{}); const p = document.getElementById('notifPopup'); p.style.display = 'block'; setTimeout(() => p.style.display = 'none', 10000); }
        }, 1000);
    }

    function parseTime(t) { const [h, m] = t.split(':'); const d = new Date(); d.setHours(h, m, 0); return d; }
    function playBeep(f, d) { try { const a = new (window.AudioContext || window.webkitAudioContext)(); const o = a.createOscillator(); const g = a.createGain(); o.connect(g); g.connect(a.destination); o.frequency.value = f; g.gain.setValueAtTime(0.05, a.currentTime); o.start(); o.stop(a.currentTime + d); } catch(e) {} }
    init();

    // Konfigurasi Versi Aplikasi
    const APP_VERSION = "2.0"; // Naikkan angka ini jika Anda melakukan update lagi nanti

    function showUpdateLog() {
        const lastVersion = localStorage.getItem('app_version');

        // Jika versi berbeda atau belum pernah buka web, tampilkan pop-up
        if (lastVersion !== APP_VERSION) {
            Swal.fire({
                title: '<strong>Update Terbaru v' + APP_VERSION + '</strong>',
                icon: 'info',
                html: `
                    <div style="text-align: left; font-size: 0.9rem; line-height: 1.6;">
                        <p>Berikut adalah pembaruan pada versi ini:</p>
                        <ul style="padding-left: 20px;">
                            <li><b>üåô Dark Mode Manual:</b> Klik ikon bulan di pojok kanan atas.</li>
                            <li><b>‚úÖ Jadwal Isya:</b> Sekarang jadwal Isya sudah muncul kembali.</li>
                            <li><b>üîÑ Hitung Mundur Otomatis:</b> Langsung pindah ke Imsak setelah buka puasa selesai.</li>
                            <li><b>üì¢ Notifikasi Adzan:</b> Suara adzan otomatis saat waktu Maghrib tiba.</li>
                            <li><b>üì± Wake Lock:</b> Layar tetap menyala saat countdown berjalan.</li>
                            <li><b>üì≤ Tombol Share:</b> Bagikan jadwal langsung ke WhatsApp grup.</li>
                        </ul>
                        <p style="margin-top:10px; color: var(--primary);"><i>Terima kasih telah menggunakan Imsakiyah Pro!</i></p>
                    </div>
                `,
                showCloseButton: true,
                focusConfirm: false,
                confirmButtonText: '<i class="fa fa-thumbs-up"></i> Siap, Mengerti!',
                confirmButtonColor: '#004d40',
                background: document.body.classList.contains('dark-theme') ? '#1e1e1e' : '#fff',
                color: document.body.classList.contains('dark-theme') ? '#e0e0e0' : '#333'
            });

            // Simpan versi terbaru agar tidak muncul lagi
            localStorage.setItem('app_version', APP_VERSION);
        }
    }

    // Jalankan pengecekan update setelah inisialisasi data
    setTimeout(showUpdateLog, 1500); // Delay 1.5 detik agar tidak bentrok dengan loading awal
</script>
</body>
</html>
