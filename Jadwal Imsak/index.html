<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imsakiyah Pro v3.6</title>
    
    <link rel="manifest" href="data:application/manifest+json,{'name':'Imsakiyah Pro','short_name':'ImsakPro','start_url':'.','display':'standalone','background_color':'#004d40','theme_color':'#004d40','icons':[{'src':'https://cdn-icons-png.flaticon.com/512/2913/2913501.png','sizes':'512x512','type':'image/png'}]}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { 
            --primary: #004d40; --accent: #ffc107; --bg: #f4f7f6; --danger: #d32f2f; 
            --maghrib: #e65100; --text: #333; --card-bg: #ffffff; --border: #eee;
        }
        body.dark-theme {
            --bg: #121212; --text: #e0e0e0; --card-bg: #1e1e1e; --border: #333;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; transition: 0.3s; min-height: 100vh; }
        
        .card { background: var(--card-bg); padding: 25px; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; position: relative; box-sizing: border-box; }
        
        #installBtn { display: none; background: var(--accent); color: var(--primary); border: none; padding: 12px 20px; border-radius: 50px; font-weight: bold; margin-bottom: 15px; cursor: pointer; width: 100%; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        .theme-toggle { position: absolute; top: 15px; right: 15px; background: var(--primary); color: white; border: none; width: 38px; height: 38px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; z-index: 10; }
        .clock-live { font-size: 1.5rem; font-weight: bold; color: var(--primary); margin-bottom: 5px; }
        .date-live { font-size: 0.9rem; opacity: 0.7; margin-bottom: 15px; border-bottom: 2px solid var(--border); padding-bottom: 10px; }
        
        .search-container { position: relative; margin: 15px 0; }
        input { width: 100%; padding: 15px; border: 2px solid var(--border); border-radius: 12px; box-sizing: border-box; outline: none; font-size: 1rem; background: var(--card-bg); color: var(--text); }
        #clearInput { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #999; display: none; }
        
        .btn-gps { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; border-radius: 12px; cursor: pointer; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.3s; }
        .btn-gps:disabled { opacity: 0.6; cursor: not-allowed; }

        .autocomplete-list { position: absolute; width: 100%; background: var(--card-bg); border: 1px solid var(--border); z-index: 99; max-height: 200px; overflow-y: auto; text-align: left; border-radius: 10px; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .autocomplete-list div { padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; }

        .countdown-card { background: var(--primary); color: white; padding: 20px; border-radius: 18px; margin-bottom: 20px; transition: 0.5s ease; }
        .countdown-time { font-size: 2.8rem; font-weight: bold; color: var(--accent); letter-spacing: 1px; }
        
        .imsak-label { font-size: 0.9rem; font-weight: bold; text-transform: uppercase; color: var(--danger); letter-spacing: 1px; }
        .imsak-display { font-size: 4rem; font-weight: bold; color: var(--danger); line-height: 1; margin: 5px 0 15px 0; }
        
        .jadwal-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .info-box { background: var(--bg); padding: 10px 5px; border-radius: 12px; font-size: 0.8rem; border: 1px solid var(--border); }
        .info-box b { display: block; font-size: 1.1rem; color: var(--text); }

        .footer { margin-top: 25px; width: 100%; max-width: 450px; text-align: center; font-size: 0.8rem; opacity: 0.9; }
        .btn-share { background: #25d366; color: white; padding: 12px 25px; border-radius: 50px; text-decoration: none; font-weight: bold; display: inline-flex; align-items: center; gap: 8px; margin-bottom: 15px; }
        .footer-note { background: #fff3e0; color: #e65100; padding: 12px; border-radius: 12px; margin-top: 10px; border: 1px solid #ffe0b2; text-align: left; line-height: 1.4; }
        body.dark-theme .footer-note { background: #2a1b00; border-color: #4d3300; }
        #notifPopup { display: none; position: fixed; top: 20px; background: var(--maghrib); color: white; padding: 15px 30px; border-radius: 50px; font-weight: bold; z-index: 10000; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }

        /* TAMBAHAN: Style khusus tombol download & poster */
        .btn-poster { background: #0288d1; color: white; border: none; padding: 12px; width: 100%; border-radius: 12px; cursor: pointer; font-weight: bold; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        /* Update Style Poster agar muat semua kolom & 31 baris */
        #poster-area { 
            position: absolute; left: -9999px; top: -9999px; 
            width: 650px; background: white; padding: 25px; color: #333; 
        }
        .poster-title { text-align: center; color: #004d40; border-bottom: 4px solid #ffc107; padding-bottom: 10px; margin-bottom: 15px; }
        .poster-table { width: 100%; border-collapse: collapse; }
        .poster-table th { background: #004d40; color: white; padding: 6px 2px; font-size: 11px; text-transform: uppercase; }
        .poster-table td { border: 1px solid #ccc; padding: 4px 2px; text-align: center; font-size: 10.5px; font-family: 'Courier New', monospace; font-weight: bold; }
        .poster-table tr:nth-child(even) { background: #f9f9f9; }
        .bg-maghrib { background: #fff3e0 !important; color: #e65100; }
    </style>
</head>
<body>

<div id="notifPopup">üîî ALLAHU AKBAR! WAKTU BERBUKA TIBA</div>

<div class="card">
    <button id="installBtn"><i class="fas fa-download"></i> Pasang Aplikasi</button>
    <button class="theme-toggle" id="themeBtn" onclick="toggleTheme()">üåô</button>
    
    <div class="clock-live" id="liveClock">00:00:00</div>
    <div class="date-live" id="liveDate">Memuat hari...</div>
    
    <h2 style="margin-top: 0;">üåô Imsakiyah Pro</h2>
    
    <button class="btn-gps" id="btnGps" onclick="getLocation()">
        <i class="fas fa-location-arrow"></i> Deteksi Lokasi Otomatis
    </button>
    
    <div class="search-container">
        <input type="text" id="inputKota" placeholder="Cari Kota/Kabupaten..." autocomplete="off">
        <span id="clearInput" onclick="hapusInput()">&#10006;</span>
        <div id="listKota" class="autocomplete-list"></div>
    </div>

    <div id="resultBox" style="display:none;">
        <div class="countdown-card" id="countCard">
            <small id="labelCount" style="font-weight:bold; text-transform:uppercase;">--</small>
            <div class="countdown-time" id="textCount">00:00:00</div>
        </div>
        
        <div style="border: 2px solid var(--border); padding: 15px; border-radius: 20px;">
            <strong id="resKota" style="text-transform: uppercase; color: var(--primary); letter-spacing: 1px;">-</strong>
            <div class="imsak-label" style="margin-top: 10px;">Waktu Imsak</div>
            <div class="imsak-display" id="resImsak">--:--</div>
            
            <div class="jadwal-grid">
                <div class="info-box">Subuh <b id="vSu">--:--</b></div>
                <div class="info-box">Dzuhur <b id="vDz">--:--</b></div>
                <div class="info-box">Ashar <b id="vAs">--:--</b></div>
                <div class="info-box">Maghrib <b id="vMa">--:--</b></div>
                <div class="info-box" style="grid-column: span 2;">Isya <b id="vIs">--:--</b></div>
            </div>
            <div id="resTanggalApi" style="font-size: 0.75rem; margin-top: 15px; opacity: 0.5;"></div>
        </div>

        <button class="btn-poster" onclick="downloadPoster()">
            <i class="fas fa-image"></i> Download Jadwal 30 Hari
        </button>
    </div>
</div>

<div id="poster-area">
    <div class="poster-title">
        <h2 style="margin:0; font-size: 22px;">JADWAL IMSAKIYAH RAMADHAN 1447 H</h2>
        <h3 id="pKota" style="margin:5px 0; color: #555;">KOTA</h3>
        <small>18 Februari 2026 - 20 Maret 2026</small>
    </div>
    <table class="poster-table">
        <thead>
            <tr>
                <th>Hari</th>
                <th>Tanggal</th>
                <th>Imsak</th>
                <th>Subuh</th>
                <th>Dzuhur</th>
                <th>Ashar</th>
                <th>Maghrib</th>
                <th>Isya</th>
            </tr>
        </thead>
        <tbody id="pBody"></tbody>
    </table>
    <div style="text-align:center; margin-top:10px; font-size:10px; color:#888;">
        ¬© 2026 Imsakiyah Pro - Sultan Ahmad Haidir | Data: Kemenag RI
    </div>
</div>

<div class="footer">
    <a href="#" id="waShare" class="btn-share" target="_blank"><i class="fab fa-whatsapp"></i> Bagikan Jadwal</a>
    <div>Dibuat oleh <strong>Sultan Ahmad Haidir</strong></div>
    <div class="footer-note">
        <strong>Pemberitahuan:</strong> Jadwal sinkron dengan API Kemenag RI. Selalu dahulukan adzan dari masjid setempat. 
    </div>
    <p>¬© 2026 Digital Imsakiyah - Versi 3.7</p>
</div>

<audio id="adzanAudio" src="https://www.islamcan.com/audio/adhan/azan1.mp3" preload="auto"></audio>

<script>
    let daftarKota = [], fuse, countdownInterval, hasBeeped = [];
    const APP_VERSION = "3.7";
    const input = document.getElementById('inputKota');
    const clearBtn = document.getElementById('clearInput');

    // 1. INITIALIZATION & MEMORY
    if(localStorage.getItem('theme') === 'dark') { 
        document.body.classList.add('dark-theme'); 
        document.getElementById('themeBtn').innerText = '‚òÄÔ∏è'; 
    }

    function toggleTheme() {
        document.body.classList.toggle('dark-theme');
        const isDark = document.body.classList.contains('dark-theme');
        document.getElementById('themeBtn').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    setInterval(() => { 
        const n = new Date();
        document.getElementById('liveClock').innerText = n.toLocaleTimeString('id-ID', { 
            hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false 
        }).replace(/\./g, ':'); 
        
        document.getElementById('liveDate').innerText = n.toLocaleDateString('id-ID', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });
    }, 1000);

    // 2. FETCH DATABASE & FUZZY SEARCH
    async function init() {
        try {
            const res = await fetch('https://api.myquran.com/v2/sholat/kota/semua');
            const data = await res.json();
            daftarKota = data.data;

            fuse = new Fuse(daftarKota, { 
                keys: ['lokasi'], 
                threshold: 0.5,
                distance: 100,
                ignoreLocation: true
            });
            
            const lastId = localStorage.getItem('lastId');
            const lastNama = localStorage.getItem('lastNama');
            if(lastId) pilihKota(lastId, lastNama);
            
            if (localStorage.getItem('app_version') !== APP_VERSION) {
                showUpdateLog();
                localStorage.setItem('app_version', APP_VERSION);
            }
        } catch (e) {
            console.error("Init Error", e);
        }
    }

    // 3. SEARCH AUTOCOMPLETE
    input.addEventListener('input', function() {
        const list = document.getElementById('listKota');
        list.innerHTML = '';
        clearBtn.style.display = this.value.length > 0 ? "block" : "none";
        
        if (this.value.length < 2) { 
            list.style.display = 'none'; 
            return; 
        }
        
        const results = fuse.search(this.value).slice(0, 7);
        
        if (results.length === 0) {
            const div = document.createElement('div');
            div.style.padding = "12px"; div.style.color = "#999";
            div.innerText = "Kota tidak ditemukan...";
            list.appendChild(div);
        } else {
            results.forEach(r => {
                const div = document.createElement('div');
                div.innerText = r.item.lokasi; 
                div.onclick = () => pilihKota(r.item.id, r.item.lokasi);
                list.appendChild(div);
            });
        }
        list.style.display = 'block';
    });

    function hapusInput() { input.value = ""; clearBtn.style.display = "none"; document.getElementById('listKota').style.display = "none"; }

    // 4. GPS LOGIC
    function getLocation() {
        const btn = document.getElementById('btnGps');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mendeteksi...';

        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;

            try {
                const res = await fetch(`https://api.myquran.com/v2/sholat/kota/lokasi/${lat}/${lon}`);
                const data = await res.json();
                
                if(data.status && data.data) {
                    pilihKota(data.data.id, data.data.lokasi);
                    Swal.fire({ title: 'Berhasil', text: data.data.lokasi, icon: 'success', timer: 1500, showConfirmButton: false });
                } else {
                    const osm = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                    const resOsm = await osm.json();
                    const namaWilayah = resOsm.address.city || resOsm.address.town || resOsm.address.county || "";
                    
                    if(namaWilayah) {
                        const hasilPencarian = fuse.search(namaWilayah);
                        if (hasilPencarian.length > 0) {
                            const kotaTerpilih = hasilPencarian[0].item;
                            pilihKota(kotaTerpilih.id, kotaTerpilih.lokasi);
                            Swal.fire({
                                title: "Lokasi Disesuaikan",
                                text: `Kami mendeteksi Anda di ${namaWilayah}, jadwal disesuaikan ke ${kotaTerpilih.lokasi}`,
                                icon: "success",
                                timer: 2500,
                                showConfirmButton: false
                            });
                        } else {
                            throw new Error("Kota tidak terdaftar");
                        }
                    } else {
                        throw new Error();
                    }
                }
            } catch (e) {
                Swal.fire("Info", "Gagal deteksi otomatis. Silakan pilih manual dari daftar.", "warning");
            }
            resetGpsBtn();
        }, () => {
            Swal.fire("Gagal", "Akses GPS ditolak.", "error");
            resetGpsBtn();
        }, { timeout: 10000 });
    }

    function resetGpsBtn() {
        const btn = document.getElementById('btnGps');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-location-arrow"></i> Deteksi Lokasi Otomatis';
    }

    // 5. DISPLAY & CORE LOGIC
    async function pilihKota(id, nama) {
        input.value = nama;
        document.getElementById('listKota').style.display = 'none';
        clearBtn.style.display = "block";
        
        localStorage.setItem('lastId', id);
        localStorage.setItem('lastNama', nama);

        const t = new Date();
        const url = `https://api.myquran.com/v2/sholat/jadwal/${id}/${t.getFullYear()}/${t.getMonth()+1}/${t.getDate()}`;
        
        try {
            const res = await fetch(url);
            const d = await res.json();
            const j = d.data.jadwal;
            displayData(j, nama);
        } catch (e) {
            Swal.fire("Offline", "Gagal memuat jadwal terbaru. Periksa internet Anda.", "warning");
        }
    }

    function displayData(j, nama) {
        document.getElementById('resultBox').style.display = 'block';
        document.getElementById('resKota').innerText = nama;
        document.getElementById('resImsak').innerText = j.imsak;
        document.getElementById('vSu').innerText = j.subuh;
        document.getElementById('vDz').innerText = j.dzuhur; 
        document.getElementById('vAs').innerText = j.ashar; 
        document.getElementById('vMa').innerText = j.maghrib;
        document.getElementById('vIs').innerText = j.isya;
        document.getElementById('resTanggalApi').innerText = j.tanggal;

        const textShare = `Jadwal Imsakiyah ${nama}:\nImsak: ${j.imsak}\nSubuh: ${j.subuh}\nMaghrib: ${j.maghrib}\n\nCek Realtime: ${window.location.href}`;
        document.getElementById('waShare').href = `https://wa.me/?text=${encodeURIComponent(textShare)}`;

        startLogic(j.imsak, j.maghrib);
    }

    function startLogic(imsakT, maghribT) {
        if(countdownInterval) clearInterval(countdownInterval);
        hasBeeped = [];
        
        countdownInterval = setInterval(() => {
            const now = new Date();
            const tImsak = parseTime(imsakT), tMaghrib = parseTime(maghribT);
            let time, label, color;

            if (tImsak > now) {
                time = tImsak - now; label = "Menuju Imsak"; color = "#004d40";
                if(Math.floor(time/60000) === 5 && !hasBeeped.includes('imsak')) { playBeep(440, 0.5); hasBeeped.push('imsak'); }
            } else if (tMaghrib > now) {
                time = tMaghrib - now; label = "Menuju Buka Puasa"; color = "#e65100";
            } else {
                time = (new Date(tImsak.getTime() + 86400000)) - now; label = "Menuju Imsak Besok"; color = "#004d40";
            }

            document.getElementById('labelCount').innerText = label;
            document.getElementById('countCard').style.background = color;
            
            const h = Math.floor(time/3600000).toString().padStart(2,'0'), 
                  m = Math.floor((time%3600000)/60000).toString().padStart(2,'0'), 
                  s = Math.floor((time%60000)/1000).toString().padStart(2,'0');
            document.getElementById('textCount').innerText = `${h}:${m}:${s}`;

            if(Math.abs(tMaghrib - now) < 1000) { 
                document.getElementById('adzanAudio').play().catch(()=>{}); 
                const p = document.getElementById('notifPopup'); p.style.display = 'block';
                setTimeout(() => p.style.display = 'none', 15000);
            }
        }, 1000);
    }

    // TAMBAHAN: Fungsi Download Poster 30 Hari
    async function downloadPoster() {
        const id = localStorage.getItem('lastId');
        const nama = localStorage.getItem('lastNama');
        if (!id) return Swal.fire("Error", "Pilih kota terlebih dahulu", "error");

        const tahun = 2026;
        
        Swal.fire({ 
            title: 'Menyusun Poster...', 
            text: 'Menggabungkan jadwal 18 Feb - 20 Mar', 
            allowOutsideClick: false, 
            didOpen: () => Swal.showLoading() 
        });

        try {
            // Ambil data Februari & Maret
            const [resFeb, resMar] = await Promise.all([
                fetch(`https://api.myquran.com/v2/sholat/jadwal/${id}/${tahun}/02`),
                fetch(`https://api.myquran.com/v2/sholat/jadwal/${id}/${tahun}/03`)
            ]);
            
            const dataFeb = await resFeb.json();
            const dataMar = await resMar.json();

            const pBody = document.getElementById('pBody');
            pBody.innerHTML = '';
            document.getElementById('pKota').innerText = nama;

            // Gabungkan & Filter tanggal 18 Feb s/d 20 Mar
            const semuaHari = [...dataFeb.data.jadwal, ...dataMar.data.jadwal];
            const jadwalRamadhan = semuaHari.filter(item => {
                return (item.date >= "2026-02-18" && item.date <= "2026-03-20");
            });

            // Masukkan ke Tabel dengan kolom yang sinkron
            jadwalRamadhan.forEach((d, index) => {
                const tglTampil = d.tanggal.split(',')[1].trim().split('/').slice(0,2).join('/'); // Hasil: "18/02"
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${tglTampil}</td>
                    <td>${d.imsak}</td>
                    <td>${d.subuh}</td>
                    <td>${d.dzuhur}</td>
                    <td>${d.ashar}</td>
                    <td class="bg-maghrib">${d.maghrib}</td>
                    <td>${d.isya}</td>
                `;
                pBody.appendChild(tr);
            });

            // Proses Capture
            setTimeout(() => {
                html2canvas(document.querySelector("#poster-area"), {
                    scale: 3, // Skala tinggi agar gambar tajam (HD)
                    logging: false,
                    useCORS: true,
                    backgroundColor: "#ffffff"
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Jadwal_Imsakiyah_1447H_${nama.replace(/ /g,'_')}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                    Swal.close();
                });
            }, 1000);

        } catch(e) {
            console.error(e);
            Swal.fire("Error", "Gagal mengambil data bulan Februari/Maret.", "error");
        }
    }

    function parseTime(t) { const [h, m] = t.split(':'); const d = new Date(); d.setHours(h, m, 0); return d; }
    function playBeep(f, d) { try { const a = new AudioContext(); const o = a.createOscillator(); const g = a.createGain(); o.connect(g); g.connect(a.destination); o.frequency.value = f; g.gain.setValueAtTime(0.1, a.currentTime); o.start(); o.stop(a.currentTime + d); } catch(e) {} }

    function showUpdateLog() {
        Swal.fire({
            title: 'Imsakiyah Pro v3.7',
            html: `
                <div style="text-align:left; font-size:0.9rem; line-height: 1.6;">
                    <p><strong>Apa yang baru di versi ini?</strong></p>
                    <ul style="padding-left: 20px;">
                        <li><b>üì∏ Download Poster 30 Hari:</b> Simpan jadwal satu bulan penuh dalam bentuk gambar (PNG) untuk dibagikan ke keluarga atau grup WA.</li>
                        <li><b>üß† Smart Fuzzy Search:</b> Pencarian kota lebih pintar, tetap ketemu meskipun ada sedikit kesalahan penulisan (typo).</li>
                        <li><b>üíæ Auto-Memory:</b> Aplikasi otomatis menyimpan lokasi terakhir Anda, tidak perlu cari ulang saat dibuka kembali.</li>
                        <li><b>üõ∞Ô∏è Precise GPS:</b> Peningkatan akurasi deteksi lokasi otomatis menggunakan integrasi OpenStreetMap.</li>
                        <li><b>üîä Adzan & Beep:</b> Notifikasi suara saat masuk waktu buka puasa dan pengingat 5 menit sebelum Imsak.</li>
                    </ul>
                </div>`,
            confirmButtonColor: '#004d40',
            confirmButtonText: 'Siap, Jalankan!'
        });
    }

    init();
</script>
</body>
</html>
